version: 2.1

# 顶层 pipeline 参数（必须在这里，才能用 << pipeline.parameters.xxx >>）
parameters:
  alpine_version_major:
    type: string
    default: "v3.23"
  alpine_version_full:
    type: string
    default: "3.23.3"
  alpine_release_rev:
    type: string
    default: "r0"

jobs:
  build-alpine-cloud:
    parameters:
      alpine_version_major:
        type: string
      alpine_version_full:
        type: string
      alpine_release_rev:
        type: string

    machine:
      image: ubuntu-2204:current
      resource_class: large

    steps:
      - checkout

      - run:
          name: 安装构建工具
          command: |
            set -euxo pipefail
            sudo apt-get update
            sudo apt-get install -y libguestfs-tools axel qemu-utils

      - run:
          name: 下载最新 Alpine Cloud Image（latest-stable）
          command: |
            set -euxo pipefail
            BASE_URL="https://dl-cdn.alpinelinux.org/alpine/latest-stable/releases/cloud"

            FILE_NAME="$(curl -fsSL "${BASE_URL}/" \
              | grep -Eo 'generic_alpine-[0-9]+\.[0-9]+\.[0-9]+-x86_64-uefi-cloudinit-r[0-9]+\.qcow2' \
              | sort -Vu \
              | tail -n1)"

            test -n "${FILE_NAME}" || (echo "未找到可用 qcow2 文件" && exit 1)

            DOWNLOAD_URL="${BASE_URL}/${FILE_NAME}"
            echo "最新镜像: ${FILE_NAME}"
            echo "下载地址: ${DOWNLOAD_URL}"

            axel -n 8 -o alpine-base.qcow2 "${DOWNLOAD_URL}"


      - run:
          name: 验证下载的镜像文件类型
          command: |
            set -euxo pipefail
            echo "--- file 输出 ---"
            file alpine-base.qcow2

            test -f alpine-base.qcow2 || (echo "错误：alpine-base.qcow2 不存在"; exit 1)
            test -s alpine-base.qcow2 || (echo "错误：alpine-base.qcow2 为空"; exit 1)

            qemu-img info alpine-base.qcow2 > qemu-img-info.txt 2>&1
            if grep -q "file format: qcow2" qemu-img-info.txt && grep -q "virtual size" qemu-img-info.txt; then
              echo "文件类型验证通过：有效 QCOW2 镜像"
              cat qemu-img-info.txt
            else
              echo "错误：qemu-img 无法识别为有效 qcow2"
              cat qemu-img-info.txt
              exit 1
            fi

      - run:
          name: 扩展 QCOW2 镜像文件容器
          command: |
            set -euxo pipefail
            sudo qemu-img resize alpine-base.qcow2 1G
            qemu-img info alpine-base.qcow2

      - run:
          name: 定制 Alpine 镜像以兼容阿里云
          command: |
            set -euxo pipefail
            export LIBGUESTFS_DEBUG=1
            export LIBGUESTFS_TRACE=1

            sudo virt-customize -a alpine-base.qcow2 \
              --smp 2 \
              --timezone Asia/Hong_Kong \
              --install sudo,chrony,cloud-init,cloud-utils-growpart \
              --run-command "mkdir -p /etc/cloud/cloud.cfg.d && printf '%s\n' \
                'growpart:' \
                '  mode: auto' \
                '  devices: [\"/\"]' \
                '  ignore_growroot_disabled: false' \
                'resize_rootfs: true' \
                > /etc/cloud/cloud.cfg.d/99-growpart.cfg" \
              --run-command "printf '%s\n' \
                'pool ntp.aliyun.com iburst' \
                'driftfile /var/lib/chrony/drift' \
                'rtcsync' \
                'makestep 1.0 3' \
                'logdir /var/log/chrony' \
                > /etc/chrony/chrony.conf" \
              --run-command "sed -i 's/#*PermitRootLogin.*/PermitRootLogin yes/g' /etc/ssh/sshd_config" \
              --run-command "sed -i 's/#*PasswordAuthentication.*/PasswordAuthentication no/g' /etc/ssh/sshd_config" \
              --append-line '/etc/ssh/sshd_config:UseDNS no' \
              --run-command "if [ -f /boot/extlinux.conf ]; then sed -i 's/\(APPEND .*\)/\1 net.ifnames=0 console=tty0 console=ttyS0,115200n8/' /boot/extlinux.conf; else echo 'skip: /boot/extlinux.conf not found'; fi" \
              --run-command 'rc-update add chronyd default || true' \
              --run-command 'rc-update add cloud-init default || true' \
              --run-command 'rc-update add cloud-config default || true' \
              --run-command 'rc-update add cloud-final default || true' \
              --run-command 'rc-update add cloud-init-local default || true' \
              --run-command 'apk cache clean' \
              --run-command "cp -f /etc/apk/repositories /etc/apk/repositories.bak" \
              --run-command "sed -Ei 's#https?://dl-cdn\.alpinelinux\.org/alpine#https://mirrors.aliyun.com/alpine#g' /etc/apk/repositories && echo '--- /etc/apk/repositories ---' && cat /etc/apk/repositories" \
              --delete '/var/log/*.log' \
              --delete '/var/cache/apk/*' \
              --run-command 'mkdir -p /etc && : > /etc/machine-id'


            
            

      - run:
          name: 压缩镜像
          command: |
            set -euxo pipefail
            export LIBGUESTFS_BACKEND=direct
            export LIBGUESTFS_DEBUG=1
            export LIBGUESTFS_TRACE=1

            if sudo virt-sparsify --compress alpine-base.qcow2 alpine-custom.qcow2; then
              echo "virt-sparsify 成功"
            else
              echo "virt-sparsify 失败，使用 qemu-img convert 兜底"
              rm -f alpine-custom.qcow2
              qemu-img convert -O qcow2 -c alpine-base.qcow2 alpine-custom.qcow2
            fi

            qemu-img info alpine-custom.qcow2
            ls -lh alpine-custom.qcow2
      - run:
          name: 准备工作区产物
          command: |
            set -euxo pipefail
            ls -lh alpine-custom.qcow2
            mkdir -p /tmp/workspace
            cp -f alpine-custom.qcow2 /tmp/workspace/alpine-custom.qcow2
            ls -lh /tmp/workspace
      - persist_to_workspace:
          root: /tmp/workspace
          paths:
            - alpine-custom.qcow2

  upload-to-release:
    parameters:
      alpine_version_full:
        type: string

    machine:
      image: ubuntu-2204:current

    steps:
      - checkout
      - attach_workspace:
          at: /tmp/workspace

      - run:
          name: 安装 GitHub CLI
          command: |
            set -euxo pipefail
            type -p curl >/dev/null || sudo apt-get install -y curl
            curl -fsSL https://cli.github.com/packages/githubcli-archive-keyring.gpg | sudo dd of=/usr/share/keyrings/githubcli-archive-keyring.gpg
            sudo chmod go+r /usr/share/keyrings/githubcli-archive-keyring.gpg
            echo "deb [arch=$(dpkg --print-architecture) signed-by=/usr/share/keyrings/githubcli-archive-keyring.gpg] https://cli.github.com/packages stable main" | sudo tee /etc/apt/sources.list.d/github-cli.list > /dev/null
            sudo apt-get update
            sudo apt-get install -y gh

      - run:
          name: 上传到 GitHub Release
          command: |
            set -euxo pipefail
            export GITHUB_TOKEN="${GH_TOKEN:?GH_TOKEN 未设置}"

            TAG_NAME="${CIRCLE_TAG:-manual-$(date +%s)}"
            echo "准备发布 Tag: $TAG_NAME"

            ls -lh /tmp/workspace/alpine-custom.qcow2

            if ! gh release view "$TAG_NAME" >/dev/null 2>&1; then
              gh release create "$TAG_NAME" \
                --title "Custom Alpine Linux Cloud Image $TAG_NAME" \
                --notes "自动发布的 Alpine Linux 阿里云优化镜像，基于 Alpine << parameters.alpine_version_full >>"
            fi

            gh release upload "$TAG_NAME" /tmp/workspace/alpine-custom.qcow2 --clobber

            # 将当前 tag 标记为 latest（替代创建名为 latest 的 tag）
            gh release edit "$TAG_NAME" --latest

workflows:
  build_and_release:
    jobs:
      - build-alpine-cloud:
          alpine_version_major: << pipeline.parameters.alpine_version_major >>
          alpine_version_full: << pipeline.parameters.alpine_version_full >>
          alpine_release_rev: << pipeline.parameters.alpine_release_rev >>
          filters:
            tags:
              only: /^v.*/
            branches:
              ignore: /.*/

      - upload-to-release:
          requires:
            - build-alpine-cloud
          alpine_version_full: << pipeline.parameters.alpine_version_full >>
          filters:
            tags:
              only: /^v.*/
            branches:
              ignore: /.*/
